# 로그 관리 시스템 문서

## 개요

이 프로젝트는 통합 로그 관리 시스템을 제공하며, 관리자가 시스템 로그를 모니터링하고 관리할 수 있는 기능을 제공합니다.

## 기능

### 1. 관리자 로그 페이지

- **경로**: `/dashboard/admin/logs`
- **권한**: 환경변수 `ADMIN_EMAILS`에 등록된 이메일만 접근 가능
- **기능**:
  - 실시간 로그 조회 및 필터링
  - 로그 통계 대시보드
  - CSV 내보내기
  - 로그 상세 정보 확인

### 2. 자동 로그 정리

- **실행 주기**: 매일 오전 2시 (Vercel Cron Jobs)
- **정리 기준**: 환경변수 `LOG_RETENTION_DAYS`에 설정된 일수
- **기본값**: 90일
- **배치 처리**: 1000개씩 배치로 처리하여 DB 부하 최소화

### 3. 수동 로그 정리

- **기능**: 관리자가 특정 조건으로 로그 정리
- **옵션**:
  - 날짜 범위 지정
  - 로그 타입 선택
  - 로그 레벨 선택
  - 드라이런 모드 (시뮬레이션)

## 환경 변수 설정

```bash
# 관리자 이메일 목록 (쉼표로 구분)
ADMIN_EMAILS="admin1@example.com,admin2@example.com"

# 로그 보존 기간 (일 단위, 기본값: 90일)
LOG_RETENTION_DAYS=90

# 로그 레벨 (기본값: INFO)
LOG_LEVEL="INFO"

# 크론잡 인증 시크릿
CRON_SECRET="your-cron-secret-here"
```

## API 엔드포인트

### 관리자 로그 관리

- `POST /api/admin/logs` - 로그 조회 (필터링 지원)
- `GET /api/admin/logs/statistics` - 로그 통계
- `GET /api/admin/logs/cleanup` - 로그 정리 통계
- `POST /api/admin/logs/cleanup` - 수동 로그 정리
- `GET /api/admin/check` - 관리자 권한 확인

### 자동 정리 (크론잡)

- `POST /api/cron/log-cleanup` - 자동 로그 정리 실행
- `GET /api/cron/log-cleanup` - 로그 정리 상태 조회

## NPM 스크립트

```bash
# 로그 시스템 테스트
npm run logs:test

# 수동 로그 정리 (SQL)
npm run logs:cleanup

# 로그 백업
npm run logs:backup

# RLS 설정
npm run logs:setup-rls

# 자동 정리 실행 (API 호출)
npm run logs:auto-cleanup

# 로그 통계 조회 (API 호출)
npm run logs:stats
```

## 보안

### Row Level Security (RLS)

- 사용자는 자신의 로그만 조회 가능
- 관리자는 모든 로그 조회 가능
- 민감한 로그 타입은 관리자만 접근 가능

### 권한 관리

- 환경변수 `ADMIN_EMAILS`로 관리자 지정
- 클라이언트에서 관리자 여부를 서버 API로 확인
- 모든 관리자 액션은 로그에 기록

## 로그 타입

1. **ACCESS**: API 접근 로그
2. **AUTH**: 인증 관련 로그
3. **AUDIT**: 감사 로그 (데이터 변경)
4. **ERROR**: 오류 로그
5. **ADMIN**: 관리자 액션 로그
6. **QR_GENERATION**: QR 코드 생성 로그
7. **SYSTEM**: 시스템 로그

## 로그 레벨

1. **DEBUG**: 디버그 정보
2. **INFO**: 일반 정보
3. **WARN**: 경고
4. **ERROR**: 오류
5. **FATAL**: 치명적 오류

## 성능 최적화

- 배치 처리로 대량 삭제 시 DB 부하 최소화
- 인덱스 활용으로 빠른 조회
- 페이지네이션으로 메모리 사용량 제한
- 백그라운드 작업으로 사용자 경험 향상

## 모니터링

- 로그 정리 작업 결과를 시스템 로그에 기록
- 통계 대시보드로 시스템 상태 모니터링
- 오류 발생 시 자동 로그 기록

## 배포 시 주의사항

1. **환경변수 설정**: 모든 필수 환경변수가 올바르게 설정되었는지 확인
2. **크론잡 등록**: Vercel에서 크론잡이 활성화되었는지 확인
3. **데이터베이스 백업**: 로그 정리 전 중요한 로그는 백업
4. **권한 확인**: 관리자 이메일이 올바르게 설정되었는지 확인

## 문제 해결

### 로그 정리가 실행되지 않는 경우

1. `CRON_SECRET` 환경변수 확인
2. Vercel 크론잡 설정 확인
3. API 엔드포인트 응답 확인

### 관리자 페이지 접근 불가

1. `ADMIN_EMAILS` 환경변수 확인
2. 이메일 주소 정확성 확인
3. 쉼표로 구분되어 있는지 확인

### 로그 조회 성능 문제

1. 날짜 범위를 좁혀서 조회
2. 필터 조건 추가로 결과 수 제한
3. 인덱스 상태 확인

## 향후 개선 사항

1. **실시간 알림**: 오류 로그 발생 시 관리자에게 이메일 알림
2. **대시보드 확장**: 더 상세한 통계 및 차트 제공
3. **로그 분석**: 패턴 분석 및 인사이트 제공
4. **성능 모니터링**: API 응답 시간 및 시스템 리소스 모니터링
